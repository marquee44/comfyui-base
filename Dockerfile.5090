FROM nvcr.io/nvidia/pytorch:24.11-py3

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Basic tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    git wget curl nano ffmpeg openssh-server htop tmux \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install JupyterLab
RUN pip install --no-cache-dir jupyterlab

# Create workspace and set as working dir
RUN mkdir -p /workspace
WORKDIR /workspace

# Clone ComfyUI into /workspace/ComfyUI
RUN git clone https://github.com/comfyanonymous/ComfyUI.git /workspace/ComfyUI

WORKDIR /workspace/ComfyUI

# Install ComfyUI requirements
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Install custom nodes
RUN cd /workspace/ComfyUI/custom_nodes && \
    git clone https://github.com/ltdrdata/ComfyUI-Manager.git && \
    git clone https://github.com/kijai/ComfyUI-KJNodes && \
    git clone https://github.com/MoonGoblinDev/Civicomfy && \
    for n in */; do \
        if [ -f "$n/requirements.txt" ]; then \
            pip install --no-cache-dir -r "$n/requirements.txt" || true; \
        fi; \
    done

# Expose ports
EXPOSE 8188 22 8080 8888

# Copy start script from repo (your start.5090.sh) and make executable
COPY start.5090.sh /start.sh
RUN chmod +x /start.sh

ENTRYPOINT ["/start.sh"]
